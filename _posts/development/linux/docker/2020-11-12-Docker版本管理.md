---
title: "Docker 快速发包"
subtitle: "Docker | 发包脚本 | 版本管理 | Git标签 | Git Tag | 快速发包"
layout: post
author: "luoruiqing"
header-style: text
tags:
  - Docker
---



> 该脚本可用于快速封包并上传Docker镜像服务器, 并获取版本, 大概步骤如下:

---

1. 进入项目目录获取 **Git** **Tag** 版本
2. 根据包名获取对应配置文件或提示
3. 输出当前包名/配置及 **commit log**
4. 创建配置文件
5. 生成镜像
6. 上传镜像

使用Docker的同学, 简单改改就可以上手使用了

## 代码

`build.sh`

```sh
set -e                                                              # 严格模式
cd $(dirname $0)                                                    # 进入目录
git pull                                                            # 拉取代码
URL="registry.云.com"                                               # Docker 地址
NAMESPACE="namespace"                                               # Docker 仓空间
VERSION=$(git describe --tags $(git rev-list --tags --max-count=1)) # 获得版本
PACKAGE=$1:${VERSION:=latest}                                       # 包名称
NOW="$(date +"%y%m%d_%H%M%S")"                                      # 打包时间
declare -A SETTINGS                                                 # ...

SETTINGS=(
    [test]="from .config_test import *" # 测试环境
)

[ ! "${SETTINGS[$1]}" ] && echo "未指定配置或配置不存在!" # 校验

echo -e "[package]:\033[41;37m $PACKAGE \033[0m"
echo -e "[setting]:\033[43;30m ${SETTINGS[$1]} \033[0m"
echo -e "\033[46;30m$(git log -n 1) \033[0m"

# ****************************************  开始  ****************************************

cat >./local_settings.py <<EOF
# $1
${SETTINGS[$1]}
EOF

# # 创建Docker文件
cat >"./Dockerfile.$NOW" <<EOF
FROM dipcode/centos7-python36 
WORKDIR /service

RUN yum -y install fontconfig kde-l10n-Chinese glibc-common gcc python-devel libevent-devel libffi-devel openssl-devel libgsasl-devel cyrus-sasl cyrus-sasl-devel cyrus-sasl-lib cyrus-sasl-gssapi gcc-c++ cyrus-sasl-plain postgresql-devel* curl # chromium

COPY ./requirement.txt /service/requirement.txt
RUN pip install --upgrade pip -i https://pypi.douban.com/simple/ && pip install -r /service/requirement.txt -i https://pypi.douban.com/simple/
# 启动
COPY ./ /service/
CMD gunicorn -c gunicorn_conf.py -b 0.0.0.0:16688 example.wsgi:application
EOF

docker login                                                       # 登录
docker build ./ -f "./Dockerfile.$NOW" -t $URL/$NAMESPACE/$PACKAGE # 创建版本镜像
docker push $URL/$NAMESPACE/$PACKAGE                               # 上传
docker tag $URL/$NAMESPACE/$PACKAGE $URL/$NAMESPACE/$1:latest      # 更新 latest
docker push $URL/$NAMESPACE/$1:latest                              # 上传 latest
docker rmi $URL/$NAMESPACE/$PACKAGE                                # 删除
rm -rf "./Dockerfile.$NOW"                                         # 删除文件

echo -e "\033[46;30m $PACKAGE \033[0m 打包完成. $(date) "


```


#### 发包

```sh
# Mac注意升级bash版本以支持 declare -A
bash build.sh 包名 
```