---
title: "Docker 版本发包"
subtitle: "Docker | 发包脚本 | 版本管理 | Git标签 | Git Tag | "
layout: post
author: "luoruiqing"
header-style: text
tags:
  - Docker
---


```sh
set -e                                                              # 严格模式
cd $(dirname $0)                                                    # 进入目录
git pull                                                            # 拉取代码
URL="云地址.com"                                                     # Docker 地址
NAMESPACE="namespace"                                               # Docker 仓库
VERSION=$(git describe --tags $(git rev-list --tags --max-count=1)) # 获得Git版本
PACKAGE=$1:${VERSION:=latest}                                       # 包名称
NOW="$(date +"%y%m%d_%H%M%S")"                                      # 打包时间

echo -e "[package]:\033[41;37m $PACKAGE \033[0m"
echo -e "\033[46;30m$(git log -n 1) \033[0m"

# ****************************************  开始  ****************************************

cat >"./Dockerfile.$NOW" <<EOF

FROM dipcode/centos7-python37
WORKDIR /service

COPY ./reqs.txt /service/requirement.txt
RUN  pip install --upgrade pip -i https://pypi.douban.com/simple/                     \
  && pip install -r /service/requirement.txt -i https://pypi.douban.com/simple/

COPY ./ /service
CMD uwsgi --ini wsgi.ini && tailf wsgi.log  # 启动

EOF

docker login                                                       # 登录
docker build ./ -f "./Dockerfile.$NOW" -t $URL/$NAMESPACE/$PACKAGE # 创建版本镜像
docker push $URL/$NAMESPACE/$PACKAGE                               # 上传
docker tag $URL/$NAMESPACE/$PACKAGE $URL/$NAMESPACE/$1:latest      # 更新 latest
docker push $URL/$NAMESPACE/$1:latest                              # 上传 latest
docker rmi $URL/$NAMESPACE/$PACKAGE                                # 删除
rm -rf "./Dockerfile.$NOW"                                         # 删除文件

echo -e "\033[46;30m $PACKAGE \033[0m 打包完成. $(date) "
# bash deployment/build.sh zm_hi_test # Mac用户 注意升级bash版本

```