---
title: "Docker 基础镜像和服务镜像"
subtitle: ""
layout: post
author: "luoruiqing"
header-style: text
tags:
  - Docker
---


在使用 **`Docker`** 打包 **镜像** 的时候, 如果经常很慢的话, 则需要做一个 **基础镜像** , 然后根据基础镜像来包 **服务镜像** , 这样可以大大节省打包发布的时间.

## 常规示例

以 `Python` 为例:

```dockerfile
# 依赖镜像 ****************************************************************************************

FROM dipcode/centos7-python36 
# 
ENV RUN_MODE=DEPLOY

# 安装服务依赖 *************************************************************************************

# 创建目录
CMD mkdir /usr/share/fonts/chinese 
# 拷贝中文支持
COPY ./utils/font/msyh.ttf /usr/share/fonts/chinese
# 修改文件权限
CMD chmod -R 755 /usr/share/fonts/chinese/*.ttf
# 安装Python底层模块所需的依赖库
RUN yum -y install gcc python-devel libevent-devel libffi-devel openssl-devel libgsasl-devel cyrus-sasl cyrus-sasl-devel cyrus-sasl-lib cyrus-sasl-gssapi gcc-c++ cyrus-sasl-plain postgresql-devel* curl chromium 

# 复制项目到镜像 ***********************************************************************************

# 拷贝项目
COPY ./ /project/
# 设置工作目录
WORKDIR /project/

# 安装Python依赖 **********************************************************************************

# 更新pip
RUN pip install --upgrade pip -i https://pypi.douban.com/simple/ 
# 安装依赖库
RUN pip install -r requirement.txt -i https://pypi.douban.com/simple/

# 启动 *******************************************************************************************

CMD sh start.sh

```

以上打包过程中, 耗时最多的两个部分

- 安装服务依赖
- 安装Python依赖


## 拆分

此时需要将安装依赖和启动拆分成两部分, 如下

#### 基础镜像(`Dockerfile-Base`)

去掉**启动**, 除了 **安装服务依赖** 以外, **复制项目到镜像** 和 **安装Python依赖** 还是需要加入基础镜像的. 这样在 `pip` 安装程序中可以忽略已经安装的模块

```dockerfile
# 依赖镜像 ****************************************************************************************

FROM dipcode/centos7-python36 
# 
ENV RUN_MODE=DEPLOY

# 安装服务依赖 *************************************************************************************

# 创建目录
CMD mkdir /usr/share/fonts/chinese 
# 拷贝中文支持
COPY ./utils/font/msyh.ttf /usr/share/fonts/chinese
# 修改文件权限
CMD chmod -R 755 /usr/share/fonts/chinese/*.ttf
# 安装Python底层模块所需的依赖库
RUN yum -y install gcc python-devel libevent-devel libffi-devel openssl-devel libgsasl-devel cyrus-sasl cyrus-sasl-devel cyrus-sasl-lib cyrus-sasl-gssapi gcc-c++ cyrus-sasl-plain postgresql-devel* curl chromium 

# 复制项目到镜像 ***********************************************************************************

# 拷贝项目
COPY ./ /project/
# 设置工作目录
WORKDIR /project/

# 安装Python依赖 **********************************************************************************

# 更新pip
RUN pip install --upgrade pip -i https://pypi.douban.com/simple/ 
# 安装依赖库
RUN pip install -r requirement.txt -i https://pypi.douban.com/simple/

# 启动 *******************************************************************************************

# ================ #
# CMD sh start.sh  #
# ================ #
# >>>>>>>>> 重点是这里, 去掉启动 <<<<<<<<<
```


#### 服务镜像(`Dockerfile`)

打开 **启动**, 这时基础镜像已经安装好了所有依赖, 但是每次 `Python` 发版都可能会修改 `包 `依赖, 同时 `pip` 可以忽略已经安装的包(微增耗时), 所以保留 **安装Python依赖** 步骤, 保证程序的健壮.

```dockerfile
# 依赖镜像 ****************************************************************************************

# >>>>>>>>> 这里是上个脚本打包的镜像名称, 通过命令指定, 这里暂时起名叫 base-image <<<<<<<<<
FROM base-image 
# 
ENV RUN_MODE=DEPLOY

# 复制项目到镜像 ***********************************************************************************

# 拷贝项目
COPY ./ /project/
# 设置工作目录
WORKDIR /project/

# 安装Python依赖 **********************************************************************************

# 更新pip
RUN pip install --upgrade pip -i https://pypi.douban.com/simple/ 
# 安装依赖库
RUN pip install -r requirement.txt -i https://pypi.douban.com/simple/

# 启动 *******************************************************************************************

CMD sh start.sh 

```

## 打包过程

```sh
# 1. 打包基本镜像 ===================================================================================

# 指定执行 Dockerfile-Base 文件, 指定镜像名称 base-image
docker build ./ -f ./Dockerfile-Base -t base-image 

# 2. 打包服务镜像 ===================================================================================

# 执行默认 Dockerfile 文件, 指定服务镜像名称为 project
docker build ./ -t project

# =================================================================================================
```

---

至此, 今后大部分情况下, 只需要打包服务镜像即可, 缩短打包耗时